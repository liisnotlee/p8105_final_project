---
title: "descriptive_stats"
author: "Muying Li"
date: "2025-11-18"
output: html_document
---

```{r load-lib, results='hide'}
library(tidyverse)
library(patchwork)
library(ggsci)
```

Set plot theme
```{r}
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.discrete.colour = function(...) scale_colour_brewer(..., palette = "Pastel2"),
  ggplot2.discrete.fill   = function(...) scale_fill_brewer(..., palette = "Pastel2"),

  ggplot2.continuous.colour = function(...) scale_colour_distiller(..., palette = "PuRd"),
  ggplot2.continuous.fill   = function(...) scale_fill_distiller(..., palette = "PuRd")
)
```

# Data Preparation

### `ht_wt` - Subject height and weight 

- `id`
- `height`: mean height
- `weight`: mean weight
- `enrollment_year`: some participants were enrolled in both 2022 and 2024, keep the latest one as enrollment year
- `height_2022`
- `height_2024`
- `weight_2022`
- `weight_2024`

Process:

1. Take the mean for subjects who have multiple heights and weights (both in 2022 and 2024), take the mean.
2. Note missing data
```{r ht-and-wt}
ht_wt = read_csv("data/height_and_weight.csv")|> 
  janitor::clean_names() |> 
  # calculate mean height/weight
  rowwise() |>
  mutate(
    avg_height = mean(c(height_2022, height_2024), na.rm = TRUE),
    avg_weight = mean(c(weight_2022, weight_2024), na.rm = TRUE)
  ) |>
  ungroup()
```

Count how many missing values:
```{r missing-value-ht-wt}
ht_wt |>
  summarise(
    missing_ht = sum(is.na(avg_height)),
    missing_wt = sum(is.na(avg_weight)),
    missing_both = sum(is.na(avg_weight) & is.na(avg_height))
  )

ht_wt |>
  filter(is.na(avg_height) | is.na(avg_weight))
```

### `hormones_and_selfreport` - hormone and self-reported data
```{r}
hormones_and_selfreport = read_csv("data/hormones_and_selfreport.csv") |> 
  janitor::clean_names() 
```

Get participants study enrollment info:

- `id`
- `study_2022`: whether enrolled in 2022 (1=Yes, 0=No)
- `study_2024`: whether enrolled in 2024 (1=Yes, 0=No)
```{r}
study_flag <- hormones_and_selfreport  |> 
  distinct(id, study_interval) |> 
  mutate(flag = 1,
         study_interval = paste0("study_", study_interval)) |> 
  pivot_wider(
    names_from = study_interval,
    values_from = flag,
    values_fill = 0  
  )
```

### `subject_info` - subject information 
```{r}
# read in csv
subject_info_raw = read_csv("data/subject-info.csv") |> 
  janitor::clean_names()
```

Process:
1. merge with `ht_wt` and `study_flag`
2. `pivot_long` for ht, wt, and study (1=2022, 2=2024, 3=2025)
3. calculate age based on enrollment study year
4. calculate BMI
```{r}
subject_info <- subject_info_raw  |> 
  # merging
  left_join(ht_wt, by = "id") |> 
  left_join(study_flag, by = "id") |>
  # add a study_flag
  mutate(
    study = case_when(
      study_2022 == 1 & study_2024 == 1 ~ 3L,  # both 2022 & 2024
      study_2022 == 1 & study_2024 == 0 ~ 1L,  
      study_2024 == 1 & study_2022 == 0 ~ 2L,  
      TRUE ~ NA_integer_
    )
  ) |> 
  # pivot_long for wt & ht
  pivot_longer(
    cols = c(weight_2022, weight_2024, height_2022, height_2024),
    names_to  = c(".value", "year"), 
    names_sep = "_"                 
  ) |> 
  rename(
    weight_yr = weight,
    height_yr = height
  ) |> 
  # keep only the relevant study year
  filter(
    (study == 1 & year == 2022) |
    (study == 2 & year == 2024) |
    (study == 3)
  ) |> 
  # calculate age
  mutate(
    year = as.numeric(year),
    birth_year = as.numeric(birth_year),
    age = year - birth_year
  ) |> 
  # get a mean age for each id
  group_by(id) |> 
  mutate(
    mean_age = mean(age, na.rm = TRUE)
  ) |> 
  ungroup()
```

# Visualization

### Age distribution

- View mean age in total (2022 & 2024)
- View age by study (2022, 2024)
```{r age-distribution-boxplot}
overall_n <- subject_info |> 
  distinct(id) |> 
  count(name = "n")

age_boxplot_all <- subject_info |> 
  ggplot(aes(x="All participants", y = mean_age)) +
  geom_boxplot(fill = "#bcbddc")+
  geom_text(
    data = overall_n,
    aes(
      x = "All participants", 
      y = max(subject_info$age, na.rm = TRUE) + 3,
      label = paste0("n = ", n)
    )
  ) +
  labs(
    x = NULL,
    y = "Mean age (years)",
    title = "Mean age of all participants"
  ) +
  ylim(15, NA) +
  theme(
    axis.text.x = element_text(size = 10),
    plot.title  = element_text(hjust = 0.5)
  )

count_df <- subject_info |> 
  distinct(id, year) |> 
  count(year, name="n")

age_boxplot_by_study <- subject_info |> 
  ggplot(aes(x = factor(year), y = age, fill = factor(year))) +
  geom_boxplot() +
  geom_text(
    data = count_df,
    aes(x = factor(year), y = max(subject_info$age, na.rm = TRUE) + 1, 
        label = paste0("n = ", n)),
    size = 4
  ) +
  labs(
    x = "Year",
    y = "Age (years)",
    fill = "Year",
    title = "Age Distribution by Study Year"
  ) +
  ylim(15, NA) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none" 
  )

age_boxplots <- age_boxplot_all + age_boxplot_by_study
```
```{r}
age_boxplots
```


### Weight, Height, BMI distribution

- boxplot for weight (all (mean)vs. by study)
- boxplot for height (all (mean)vs. by study)
- boxplot for BMI
